<!DOCTYPE html>
<head lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!--  <link th:href="@{/css/layout1.css}" rel="stylesheet">-->

    <!-- JS, Popper.js, and jQuery -->
    <!--  모달창 사용시 순서 중요-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>


    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBuiZ9Ad8RJWA9bioHcKMncGvR4CCTJtCY&libraries=places&callback=initMap" async defer></script>

    <script>
        var map;
        var geocoder;
        var directionsService;
        var directionsRenderer;
        var startLocation;
        var endLocation;
        var midLat;
        var midLng;
        var waypointName;


        //

        $(document).ready(function() {

            $(".callGeoBtn").on("click", function () {

                findGeo();
            });

            $(".callRouteBtn").on("click", function () {
                findRoute();
            });
        });

        //

        function initMap() {
            console.log("initMap 호출됨");

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: 25.043561, lng: 121.556668 },
                styles : [
                    {
                        "featureType": "administrative",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#444444"
                            }
                        ]
                    },
                    {
                        "featureType": "administrative.country",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "visibility": "on"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [
                            {
                                "color": "#f2f2f2"
                            }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [
                            {
                                "saturation": -100
                            },
                            {
                                "lightness": 45
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "simplified"
                            }
                        ]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [
                            {
                                "color": "#375868"
                            },
                            {
                                "visibility": "on"
                            }
                        ]
                    }
                ]

            });

            var inputDepart = document.getElementById('origin');
            var autoDepart = new google.maps.places.Autocomplete(inputDepart);
            // 선택된 장소가 변경될 때 이벤트 리스너 추가
            autoDepart.addListener('place_changed', function () {
                const place = autoDepart.getPlace();

                // 선택된 장소의 위치를 가져옴
                const location = place.geometry.location;

                // 선택된 장소의 위치로 지도 중심 이동
                map.setCenter(location);
            });

            var inputArrive = document.getElementById('destination');
            var autoArrive = new google.maps.places.Autocomplete(inputArrive);

            autoArrive.addListener('place_changed', function () {
                const place = autoArrive.getPlace();

                // 선택된 장소 정보를 사용자에게 표시하거나 다른 작업 수행
                console.log('선택된 장소:', place);

                // 선택된 장소의 위치를 가져옴
                const location = place.geometry.location;


                // 선택된 장소의 위치로 지도 중심 이동
                map.setCenter(location);
            });

        }

        function findGeo(){

            var geoOrigin = document.getElementById('origin').value;
            var geoDestination  = document.getElementById('destination').value;

            geocoder = new google.maps.Geocoder();

            geocoder.geocode({ 'address': geoOrigin }, function (startResults, startStatus) {
                if (startStatus === 'OK') {
                    // 목적지 주소를 지오코딩하여 위치 정보 가져오기
                    geocoder.geocode({ 'address': geoDestination }, function (endResults, endStatus) {
                        if (endStatus === 'OK') {
                            console.log("지오코딩 호출됨")
                            startLocation = startResults[0].geometry.location;
                            endLocation = endResults[0].geometry.location;

                            midLat = (startLocation.lat() + endLocation.lat())/2;
                            midLng = (startLocation.lng() + endLocation.lng())/2;
                        } else {
                            alert('목적지 주소의 지오코딩에 실패했습니다. 상태: ' + endStatus);
                        }
                    });
                } else {
                    alert('출발지 주소의 지오코딩에 실패했습니다. 상태: ' + startStatus);
                }
            });
        }

        function findRoute(){

            var origin = document.getElementById('origin').value;
            var destination  = document.getElementById('destination').value;

            var request = {
                origin: origin,
                destination: destination,
                //
                travelMode: 'WALKING'
            };

            directionsService = new google.maps.DirectionsService();

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map
            });

            // directionsRenderer.setDirections({routes: []});

            directionsService.route(request,
                function(result, status) {
                if (status == 'OK') {

                    clearDirections();
                    directionsRenderer.setDirections(result);
                    directionsRenderer.setOptions({ polylineOptions: { strokeColor: '#FF0000' } });
                    console.log("route 호출");

                    const moveTimeMarker = new google.maps.Marker({
                        map: map,
                        position: startLocation,
                    });

                    var route = result.routes[0];

                    //---------------------- 이동 시간 정보를 추출 -------------------------
                    var duration = route.legs[0].duration.text;
                    var mode = route.legs[0].steps[0].travel_mode;
                    console.log(mode);

                    var travelTimeInfoWindow = new google.maps.InfoWindow({
                        content: '예상 이동 시간: ' + duration
                    });
                    travelTimeInfoWindow.open(map, moveTimeMarker);


//---------------------- 레스토랑 검색 -------------------------
                    var service = new google.maps.places.PlacesService(map);
                    var infowindow;

                    service.nearbySearch({
                        location: new google.maps.LatLng(midLat,midLng),       //이 오리진을 latLng 로 변경해ㅑㅇ하나 ? -> ㅐ
                        radius: '5000', // 5km 반경 내에서 검색 (5000)
                        type: ['restaurant']
                        // minPriceLevel: 4 // 별 4개 이상
                    }, function(results, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {

                            infowindow = new google.maps.InfoWindow();

                            // 결과를 처리하고 지도에 표시
                            for (var i = 0; i < results.length; i++) {
                                const place = results[i];

                                if (place.rating >= 4 && place.user_ratings_total >= 1000) {

                                    const marker = new google.maps.Marker({
                                        map: map,
                                        position: place.geometry.location,
                                        title: place.name
                                    });

                                    const markerInfowindow = new google.maps.InfoWindow();

                                    marker.addListener('click', () => {
                                        waypointName = place.name;

                                        const contentString = '<div><strong>' + place.name + '</strong><br>' +
                                            '평점: ' + place.rating + '<br>' +
                                            '댓글 수: ' + place.user_ratings_total + '<br>' +
                                            '<button onclick="findMiddleRoute(' + marker.getPosition().lat() + ', ' + marker.getPosition().lng() + ')" type="button"> '+ '추가' + '</button> '+
                                            '</div>';

                                        markerInfowindow.setContent(contentString);
                                        markerInfowindow.open(map, marker);
                                    });

                                }

                                displayRestaurantList(results);
                            }

                            // map.addListener('click', function() {
                            //     markerInfowindow.close();
                            // });

                        } else{
                            console.log("nearbySearch 실패 ");
                            console.log(status);
                            console.log("nearbySearch 내의 startLocation : " + startLocation  );

                        }
                    });
                } else {
                    alert('경로를 찾을 수 없습니다.');

                }
            });
        }


        //---------------------- 경유지 경유하는 루트-------------------------
        function findMiddleRoute(stopoverLat,stopoverLng) {

            // const selectOriDest = document.getElementById('selectOriDest');
            // if (selectOriDest.style.display === 'none') {
            //     selectOriDest.style.display = 'block';
            // } else {
            //     selectOriDest.style.display = 'none';
            // }

            // //
            // const setAgainBtn = document.getElementById('setAgainBtn');
            // if (setAgainBtn.style.display === 'block') {
            //     setAgainBtn.style.display = 'none';
            //     console.log(setAgainBtn.style.display);
            // } else {
            //     setAgainBtn.style.display = 'block';
            //     console.log(setAgainBtn.style.display);
            // }

            // const leftOfLeft = document.getElementById('leftOfLeft');
            // if (leftOfLeft.style.display === 'none') {
            //     leftOfLeft.style.display = 'block';
            // } else {
            //     leftOfLeft.style.display = 'none';
            // }
            //
            // const rightHalf = document.getElementById('right-half');
            // rightHalf.style.width = '75%';
            //
            // const leftHalf = document.getElementById('left-half');
            // leftHalf.style.width = '25%';



            const start = document.getElementById('origin').value;
            const end = document.getElementById('destination').value;
            const waypoint = new google.maps.LatLng(stopoverLat,stopoverLng);


            //---------------------- 경로 디테일 부분 -------------------------
            geocoder = new google.maps.Geocoder();

            geocoder.geocode({ location: new google.maps.LatLng(stopoverLat,stopoverLng) })
                .then((response) => {
                    if (response.results[0]) {

                    } else {
                        window.alert("findMiddleRoute No results found");
                    }
                })
                .catch((e) => window.alert("Geocoder failed due to: " + e));

            var request = {
                origin: start,
                destination: end,
                waypoints: [{ location: waypoint, stopover: true }], // 경유지 설정
                // travelMode: google.maps.TravelMode.WALKING,
                travelMode: 'WALKING'
            };

            // directionsRenderer.setMap(null);

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map
            });

            //---------------------- 경유지 경유 루트 부분 -------------------------

            directionsService.route(request, function (result, status) {
                if (status == google.maps.DirectionsStatus.OK) {

                    clearDirections();
                    directionsRenderer.setDirections(result);

                    const moveTimeMarker = new google.maps.Marker({
                        map: map,
                        position: waypoint,
                    });

                    var route = result.routes[0];
                    var totalDuration = 0;

                    for (var i = 0; i < route.legs.length; i++) {
                        totalDuration += route.legs[i].duration.value;
                    }
                    // 이동 시간을 초로 반환하므로 분으로 변환
                    var totalMinutes = Math.round(totalDuration / 60);

                    console.log('총 이동 시간 (분): ' + totalMinutes);

                    var hours = 0;
                    var minutes = totalMinutes;
                    var timeContent;
                    if (totalMinutes >= 60) {
                        hours = Math.floor(totalMinutes / 60);
                        minutes = totalMinutes % 60;
                        timeContent = '예상 이동 시간: ' + hours +'시간 ' + minutes + '분'
                    }else{
                        timeContent = minutes + '분'
                    }

                    var mode = route.legs[0].steps[0].travel_mode;
                        console.log(mode);

                    var infowindow1 = new google.maps.InfoWindow({
                        content: timeContent
                    });
                    infowindow1.open(map, moveTimeMarker);


                    const stopoverRoute = document.getElementById('withStopoverRouteDetail');
                    stopoverRoute.className = 'routeDetail';
                    stopoverRoute.innerHTML = `
                        <div>
                            <strong>출발지 : ${start}</strong>
                        </div>
                        <div>
                            <strong>경유지 : ${waypointName}</strong>
                        </div>
                        <div>
                            <strong>도착지 : ${end}</strong>
                        </div>
                        <div>
                           <strong>예상시간  : ${timeContent}</strong>
                        </div>
                        <div>
                           <strong>이동 모드  : ${mode}</strong>
                        </div>

                        `;
                }
            });
        }

        function displayRestaurantList(results) {

            console.log("displayRestaurantList 호출됨")
            const restaurantList = document.getElementById('restaurant-list');
            // restaurantList.innerHTML = '<h2>레스토랑 리스트</h2>';
            //이거 없으면 누적되서 restaurant 가 점점 늘어남
            restaurantList.innerHTML = '';

            for (var i = 0; i < results.length; i++) {
                const place = results[i];
                if (place.rating >= 4 && place.user_ratings_total >= 100) {
                    const listItem = document.createElement('div');
                    listItem.className = 'restaurant-item';
                    listItem.innerHTML = `
                          <strong class="restListPlaceName">${place.name}</strong>
                          <p>평점: ${place.rating}</p>
                          <p>댓글 수: ${place.user_ratings_total}</p> `;

                    restaurantList.appendChild(listItem);
                }
            }
        };

        function clearDirections() {
            if (directionsRenderer) {
                console.log("clearDirections()")
                directionsRenderer.setDirections({ routes: [] });
            }
        }



        window.onload = function () {
            initMap();
        };

        function setAgain() {

            location.href = "/exploreByDest";
        }


    </script>

    <style>

        body{
            overflow: hidden;
        }

        select{
            margin-right:10px;
        }

        .left-half {
            float: left;
            width: 50%;
        }

        /* 오른쪽 절반 스타일 */
        .right-half {
            float: right;
            width: 50%;
        }

        #selectOriDest {
            display: block;
        }

        /*#setAgainBtn {*/
        /*    display: none;*/
        /*}*/

        /*#leftOfLeft {*/
        /*    display: block;*/
        /*}*/

        .restListBox{
            height: 95vh;
            overflow: auto;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .restaurant-item{
            margin-right: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px;
            width: 300px; /* 예시로 너비를 지정 */
            height: auto; /* 예시로 높이를 지정 */
            background-color: #fff; /* 배경색 지정 */
            border-radius: 8px; /* 테두리를 둥글게 만듭니다. */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* 그림자 효과 추가 */
            overflow: hidden; /* 넘치는 부분은 숨김 처리합니다. */
            text-overflow: ellipsis; /* 넘치는 텍스트에 '...'을 추가하여 표시합니다. */
        }

        .restListPlaceName{

            white-space: nowrap; /* 텍스트가 줄 바꿈되지 않도록 합니다. */
            overflow: hidden; /* 넘치는 부분은 숨김 처리합니다. */
            text-overflow: ellipsis; /* 넘치는 텍스트에 '...'을 추가하여 표시합니다. */
        }

        #withStopoverRouteDetail{

            margin-top: 20px;
            width: 350px; /* 예시로 너비를 지정 */
            height: 500px; /* 예시로 높이를 지정 */
            background-color: #fff; /* 배경색 지정 */
            border-radius: 8px; /* 테두리를 둥글게 만듭니다. */

        }

        .routeDetail{
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* 그림자 효과 추가 */
        }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-sm bg-primary navbar-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarTogglerDemo03"
            aria-controls="navbarTogglerDemo03"
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/">旅行</a>

    <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
        <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item">
                <a class="nav-link" href="/waypointTest">wayPointTest</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main2">main2</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/tripCard">tripCard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/uploadCityImg">uploadCityImg</a>
            </li>
        </ul>
    </div>
</nav>

    <div id="content">
        <div id="left-half" class="left-half">
            <div class="container">
                <div class="row">
                    <div id="leftOfLeft" class="col-md-6">

                        <div id="selectOriDest">
                            <h1>경로 설정 창</h1>
                                <input id="origin" placeholder="출발지를 입력하세요" type="text">
                                <input id="destination" placeholder="도착지를 입력하세요" type="text">

                            <button type="button" class="btn btn-primary w-100 mb-2 mt-3 callGeoBtn">1.확인</button>
                            <button type="button" class="btn btn-primary w-100 callRouteBtn">2.찾기</button>
                        </div>

                        <div id="withStopoverRouteDetail"></div>

    <!--                    <button type="button" id="setAgainBtn" class="btn btn-primary mt-3 " onclick="setAgain()">다시검색하기</button>-->
                    </div>

                    <div class="col-md-6 restListBox">
                        <div id="restaurant-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="right-half" class="right-half">
            <div id="map" style="width: 100%; height: 95vh;"></div>
        </div>
    </div>
</body>
